From 85dd4a0e0fdf5fbbf53a2aac2328135c461dce77 Mon Sep 17 00:00:00 2001
From: Christophe Priouzeau <christophe.priouzeau@st.com>
Date: Tue, 13 Feb 2018 17:55:02 +0100
Subject: [PATCH 3/4] 4.15: ST: devicetree

Signed-off-by: Christophe Priouzeau <christophe.priouzeau@st.com>
---
 arch/arm/boot/dts/stih407-family.dtsi  | 23 ++++++++-
 arch/arm/boot/dts/stih407-pinctrl.dtsi | 35 +++++++++++++
 arch/arm/boot/dts/stih410-b2120.dts    |  5 ++
 arch/arm/boot/dts/stih410-b2260.dts    | 18 ++++++-
 arch/arm/boot/dts/stih410.dtsi         | 93 ++++++++++++++++++++++++++++++++++
 arch/arm/boot/dts/stihxxx-b2120.dtsi   | 23 ++++++++-
 6 files changed, 193 insertions(+), 4 deletions(-)

diff --git a/arch/arm/boot/dts/stih407-family.dtsi b/arch/arm/boot/dts/stih407-family.dtsi
index cf37569..725c703 100644
--- a/arch/arm/boot/dts/stih407-family.dtsi
+++ b/arch/arm/boot/dts/stih407-family.dtsi
@@ -53,7 +53,6 @@
 			clocks = <&clk_m_a9>;
 			clock-names = "cpu";
 			clock-latency = <100000>;
-			cpu0-supply = <&pwm_regulator>;
 			st,syscfg = <&syscfg_core 0x8e0>;
 		};
 		cpu@1 {
@@ -989,5 +988,27 @@
 				 <&clk_s_c0_flexgen CLK_ST231_DMU>,
 				 <&clk_s_c0_flexgen CLK_FLASH_PROMIP>;
 		};
+
+		rc: rc@09518000 {
+			compatible = "st,comms-irb";
+			reg = <0x09518000 0x234>;
+			interrupts = <GIC_SPI 132 IRQ_TYPE_NONE>;
+			rx-mode = "infrared";
+			pinctrl-names = "default";
+			pinctrl-0 = <&pinctrl_ir
+				     &pinctrl_uhf
+				     &pinctrl_tx
+				     &pinctrl_tx_od>;
+			clocks = <&clk_sysin>;
+			resets = <&softreset STIH407_IRB_SOFTRESET>;
+
+			status = "disabled";
+		};
+
+		socinfo {
+			compatible = "st,stih407-socinfo";
+			st,syscfg = <&syscfg_core>;
+		};
+
 	};
 };
diff --git a/arch/arm/boot/dts/stih407-pinctrl.dtsi b/arch/arm/boot/dts/stih407-pinctrl.dtsi
index a290900..a263a01 100644
--- a/arch/arm/boot/dts/stih407-pinctrl.dtsi
+++ b/arch/arm/boot/dts/stih407-pinctrl.dtsi
@@ -1023,6 +1023,41 @@
 				st,retime-pin-mask = <0x7f>;
 			};
 
+			dvo {
+				pinctrl_dvo: dvo {
+					st,pins {
+						hs = <&pio30 0 ALT2 OUT SE_NICLK_IO 0 CLK_A>;
+						vs = <&pio30 1 ALT2 OUT SE_NICLK_IO 0 CLK_A>;
+						de = <&pio30 2 ALT2 OUT SE_NICLK_IO 0 CLK_A>;
+						ck = <&pio30 3 ALT2 (OE | CLKNOTDATA) 0>;
+						d0 = <&pio30 4 ALT2 OUT SE_NICLK_IO 0 CLK_A>;
+						d1 = <&pio30 5 ALT2 OUT SE_NICLK_IO 0 CLK_A>;
+						d2 = <&pio30 6 ALT2 OUT SE_NICLK_IO 0 CLK_A>;
+						d3 = <&pio30 7 ALT2 OUT SE_NICLK_IO 0 CLK_A>;
+						d4 = <&pio31 0 ALT2 OUT SE_NICLK_IO 0 CLK_A>;
+						d5 = <&pio31 1 ALT2 OUT SE_NICLK_IO 0 CLK_A>;
+						d6 = <&pio31 2 ALT2 OUT SE_NICLK_IO 0 CLK_A>;
+						d7 = <&pio31 3 ALT2 OUT SE_NICLK_IO 0 CLK_A>;
+						d8 = <&pio31 4 ALT2 OUT SE_NICLK_IO 0 CLK_A>;
+						d9 = <&pio31 5 ALT2 OUT SE_NICLK_IO 0 CLK_A>;
+						d10 = <&pio31 6 ALT2 OUT SE_NICLK_IO 0 CLK_A>;
+						d11 = <&pio31 7 ALT2 OUT SE_NICLK_IO 0 CLK_A>;
+						d12 = <&pio32 0 ALT2 OUT SE_NICLK_IO 0 CLK_A>;
+						d13 = <&pio32 1 ALT2 OUT SE_NICLK_IO 0 CLK_A>;
+						d14 = <&pio32 2 ALT2 OUT SE_NICLK_IO 0 CLK_A>;
+						d15 = <&pio32 3 ALT2 OUT SE_NICLK_IO 0 CLK_A>;
+						d16 = <&pio32 4 ALT2 OUT SE_NICLK_IO 0 CLK_A>;
+						d17 = <&pio32 5 ALT2 OUT SE_NICLK_IO 0 CLK_A>;
+						d18 = <&pio32 6 ALT2 OUT SE_NICLK_IO 0 CLK_A>;
+						d19 = <&pio32 7 ALT2 OUT SE_NICLK_IO 0 CLK_A>;
+						d20 = <&pio33 0 ALT2 OUT SE_NICLK_IO 0 CLK_A>;
+						d21 = <&pio33 1 ALT2 OUT SE_NICLK_IO 0 CLK_A>;
+						d22 = <&pio33 2 ALT2 OUT SE_NICLK_IO 0 CLK_A>;
+						d23 = <&pio33 3 ALT2 OUT SE_NICLK_IO 0 CLK_A>;
+					};
+				};
+			};
+
 			i2c4 {
 				pinctrl_i2c4_default: i2c4-default {
 					st,pins {
diff --git a/arch/arm/boot/dts/stih410-b2120.dts b/arch/arm/boot/dts/stih410-b2120.dts
index 9830be5..3ee9b6f 100644
--- a/arch/arm/boot/dts/stih410-b2120.dts
+++ b/arch/arm/boot/dts/stih410-b2120.dts
@@ -66,5 +66,10 @@
 				status = "okay";
 			};
 		};
+
+		sti-hda@8d02000 {
+			status = "okay";
+		};
+
 	};
 };
diff --git a/arch/arm/boot/dts/stih410-b2260.dts b/arch/arm/boot/dts/stih410-b2260.dts
index c663b70..d392d0f 100644
--- a/arch/arm/boot/dts/stih410-b2260.dts
+++ b/arch/arm/boot/dts/stih410-b2260.dts
@@ -15,7 +15,7 @@
 	compatible = "st,stih410-b2260", "st,stih410";
 
 	chosen {
-		bootargs = "console=ttyAS1,115200 clk_ignore_unused";
+		bootargs = "console=ttyAS1,115200";
 		linux,stdout-path = &uart1;
 	};
 
@@ -57,6 +57,20 @@
 				gpios = <&pio2 5 GPIO_ACTIVE_LOW>;
 				default-state = "off";
 			};
+
+			wifi_yellow {
+				label = "Wifi_yellow";
+				gpios = <&pio4 0 GPIO_ACTIVE_LOW>;
+				linux,default-trigger = "wifi-activity";
+				default-state = "off";
+			};
+
+			bt_blue {
+				label = "Bluetooth_blue";
+				gpios = <&pio3 3 GPIO_ACTIVE_LOW>;
+				linux,default-trigger = "hci0-power";
+				default-state = "off";
+			};
 		};
 
 		/* Low speed expansion connector */
@@ -178,7 +192,7 @@
 			/* HDMI V1.3a supports Standard mode only */
 			clock-frequency = <100000>;
 			st,i2c-min-scl-pulse-width-us = <0>;
-			st,i2c-min-sda-pulse-width-us = <5>;
+			st,i2c-min-sda-pulse-width-us = <1>;
 			status = "okay";
 		};
 
diff --git a/arch/arm/boot/dts/stih410.dtsi b/arch/arm/boot/dts/stih410.dtsi
index cffa50d..d82c189 100644
--- a/arch/arm/boot/dts/stih410.dtsi
+++ b/arch/arm/boot/dts/stih410.dtsi
@@ -14,7 +14,52 @@
 		bdisp0 = &bdisp0;
 	};
 
+	cpus {
+		cpu@0 {
+			st,syscfg = <&syscfg_core 0x8e0>;
+			st,syscfg-eng = <&syscfg_opp 0x4 0x0>;
+			clocks = <&clk_m_a9>;
+			operating-points-v2 = <&cpu0_opp_table>;
+		};
+		cpu@1 {
+			clocks = <&clk_m_a9>;
+			operating-points-v2 = <&cpu0_opp_table>;
+		};
+	};
+
+	cpu0_opp_table: opp_table0 {
+		compatible = "operating-points-v2";
+		opp-shared;
+
+		opp@1500000000 {
+			opp-supported-hw = <0xffffffff  0xffffffff  0xffffffff>;
+			opp-hz = /bits/ 64 <1500000000>;
+			clock-latency-ns = <10000000>;
+			opp-suspend;
+		};
+		opp@1200000000 {
+			opp-supported-hw = <0xffffffff  0xffffffff  0xffffffff>;
+			opp-hz = /bits/ 64 <1200000000>;
+			clock-latency-ns = <10000000>;
+		};
+		opp@800000000 {
+			opp-supported-hw = <0xffffffff  0xffffffff  0xffffffff>;
+			opp-hz = /bits/ 64 <800000000>;
+			clock-latency-ns = <10000000>;
+		};
+		opp@400000000 {
+			opp-supported-hw = <0xffffffff  0xffffffff  0xffffffff>;
+			opp-hz = /bits/ 64 <400000000>;
+			clock-latency-ns = <10000000>;
+		};
+	};
+
 	soc {
+		syscfg_opp: @08a6583c {
+			compatible = "syscon";
+			reg = <0x08a6583c 0x8>;
+		};
+
 		usb2_picophy1: phy2 {
 			compatible = "st,stih407-usb2-phy";
 			#phy-cells = <0>;
@@ -195,6 +240,7 @@
 
 			sti_hdmi: sti-hdmi@8d04000 {
 				compatible = "st,stih407-hdmi";
+				#sound-dai-cells = <0>;
 				reg = <0x8d04000 0x1000>;
 				reg-names = "hdmi-reg";
 				interrupts = <GIC_SPI 106 IRQ_TYPE_NONE>;
@@ -234,6 +280,23 @@
 					 <&clk_s_d2_quadfs 1>;
 			};
 
+			sti-dvo@8d00400 {
+				compatible = "st,stih407-dvo";
+				status = "disabled";
+				reg = <0x8d00400 0x200>;
+				reg-names = "dvo-reg";
+				clock-names = "dvo_pix",
+					      "dvo",
+					      "main_parent",
+					      "aux_parent";
+				clocks = <&clk_s_d2_flexgen CLK_PIX_DVO>,
+					 <&clk_s_d2_flexgen CLK_DVO>,
+					 <&clk_s_d2_quadfs 0>,
+					 <&clk_s_d2_quadfs 1>;
+				pinctrl-names = "default";
+				pinctrl-0 = <&pinctrl_dvo>;
+			};
+
 			sti-hqvdp@9c000000 {
 				compatible = "st,stih407-hqvdp";
 				reg = <0x9C00000 0x100000>;
@@ -294,5 +357,35 @@
 			resets = <&softreset STIH407_LPM_SOFTRESET>;
 			hdmi-phandle = <&sti_hdmi>;
 		};
+
+		mali: mali@09f00000 {
+			compatible	= "arm,mali-400";
+			reg		= <0x09f00000 0x10000>;
+			interrupts	= <GIC_SPI 49 IRQ_TYPE_NONE>,
+					  <GIC_SPI 50 IRQ_TYPE_NONE>,
+					  <GIC_SPI 41 IRQ_TYPE_NONE>,
+					  <GIC_SPI 45 IRQ_TYPE_NONE>,
+					  <GIC_SPI 42 IRQ_TYPE_NONE>,
+					  <GIC_SPI 46 IRQ_TYPE_NONE>,
+					  <GIC_SPI 43 IRQ_TYPE_NONE>,
+					  <GIC_SPI 47 IRQ_TYPE_NONE>,
+					  <GIC_SPI 44 IRQ_TYPE_NONE>,
+					  <GIC_SPI 48 IRQ_TYPE_NONE>;
+			interrupt-names = "IRQGP",
+					  "IRQGPMMU",
+					  "IRQPP0",
+					  "IRQPPMMU0",
+					  "IRQPP1",
+					  "IRQPPMMU1",
+					  "IRQPP2",
+					  "IRQPPMMU2",
+					  "IRQPP3",
+					  "IRQPPMMU3";
+			clock-names	= "gpu-clk";
+			clocks		= <&clk_s_c0_flexgen CLK_ICN_GPU>;
+			reset-names	= "gpu";
+			resets		= <&softreset STIH407_GPU_SOFTRESET>;
+		};
+
 	};
 };
diff --git a/arch/arm/boot/dts/stihxxx-b2120.dtsi b/arch/arm/boot/dts/stihxxx-b2120.dtsi
index 7f80c2c..d71990c 100644
--- a/arch/arm/boot/dts/stihxxx-b2120.dtsi
+++ b/arch/arm/boot/dts/stihxxx-b2120.dtsi
@@ -56,6 +56,15 @@
 
 		i2c@9845000 {
 			status = "okay";
+
+			#address-cells = <1>;
+			#size-cells = <0>;
+
+			eeprom@50 {
+				compatible = "at,24c256";
+				pagesize = <64>;
+				reg = <0x50>;
+			};
 		};
 
 		i2c@9540000 {
@@ -77,7 +86,7 @@
 			/* HDMI V1.3a supports Standard mode only */
 			clock-frequency = <100000>;
 			st,i2c-min-scl-pulse-width-us = <0>;
-			st,i2c-min-sda-pulse-width-us = <5>;
+			st,i2c-min-sda-pulse-width-us = <1>;
 		};
 
 		miphy28lp_phy: miphy28lp@9b22000 {
@@ -88,6 +97,8 @@
 
 			phy_port1: port@9b2a000 {
 				st,osc-force-ext;
+				/* SATA via B2136 MiniPCIe to eSATA/SATA board */
+				st,sata_gen = "gen3";
 			};
 		};
 
@@ -196,5 +207,15 @@
 				};
 			};
 		};
+
+		sata1: sata@9b28000 {
+			status = "okay";
+		};
+
+		rc: rc@09518000 {
+			status = "okay";
+			pinctrl-0 = <&pinctrl_ir>;
+		};
+
 	};
 };
-- 
2.7.4

