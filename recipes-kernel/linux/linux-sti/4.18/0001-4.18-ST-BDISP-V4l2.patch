From 17bd17031864300eb0f43238b402ee590599bc56 Mon Sep 17 00:00:00 2001
From: Christophe Priouzeau <christophe.priouzeau@st.com>
Date: Tue, 14 Aug 2018 15:14:29 +0200
Subject: [PATCH 1/3] 4.18: ST: BDISP V4l2

---
 drivers/media/platform/sti/bdisp/bdisp-v4l2.c | 22 ++++++++++++++++------
 1 file changed, 16 insertions(+), 6 deletions(-)

diff --git a/drivers/media/platform/sti/bdisp/bdisp-v4l2.c b/drivers/media/platform/sti/bdisp/bdisp-v4l2.c
index 66b6409..cca70fb 100644
--- a/drivers/media/platform/sti/bdisp/bdisp-v4l2.c
+++ b/drivers/media/platform/sti/bdisp/bdisp-v4l2.c
@@ -49,7 +49,7 @@ static const struct bdisp_fmt bdisp_formats[] = {
 		.nb_planes      = 1,
 		.bpp            = 32,
 		.bpp_plane0     = 32,
-		.w_align        = 1,
+		.w_align        = 2,
 		.h_align        = 1
 	},
 	/* XRGB888. [31:0] x:R:G:B 8:8:8:8 little endian */
@@ -58,7 +58,7 @@ static const struct bdisp_fmt bdisp_formats[] = {
 		.nb_planes      = 1,
 		.bpp            = 32,
 		.bpp_plane0     = 32,
-		.w_align        = 1,
+		.w_align        = 2,
 		.h_align        = 1
 	},
 	/* RGB565. [15:0] R:G:B 5:6:5 little endian */
@@ -67,7 +67,7 @@ static const struct bdisp_fmt bdisp_formats[] = {
 		.nb_planes      = 1,
 		.bpp            = 16,
 		.bpp_plane0     = 16,
-		.w_align        = 1,
+		.w_align        = 4,
 		.h_align        = 1
 	},
 	/* NV12. YUV420SP - 1 plane for Y + 1 plane for (CbCr) */
@@ -76,7 +76,7 @@ static const struct bdisp_fmt bdisp_formats[] = {
 		.nb_planes      = 2,
 		.bpp            = 12,
 		.bpp_plane0     = 8,
-		.w_align        = 2,
+		.w_align        = 8,
 		.h_align        = 2
 	},
 	/* RGB888. [23:0] B:G:R 8:8:8 little endian */
@@ -85,7 +85,7 @@ static const struct bdisp_fmt bdisp_formats[] = {
 		.nb_planes      = 1,
 		.bpp            = 24,
 		.bpp_plane0     = 24,
-		.w_align        = 1,
+		.w_align        = 8,
 		.h_align        = 1
 	},
 	/* YU12. YUV420P - 1 plane for Y + 1 plane for Cb + 1 plane for Cr
@@ -96,7 +96,7 @@ static const struct bdisp_fmt bdisp_formats[] = {
 		.nb_planes      = 3,
 		.bpp            = 12,
 		.bpp_plane0     = 8,
-		.w_align        = 2,
+		.w_align        = 8,
 		.h_align        = 2
 	}
 };
@@ -554,6 +554,9 @@ static int queue_init(void *priv,
 	src_vq->lock = &ctx->bdisp_dev->lock;
 	src_vq->dev = ctx->bdisp_dev->v4l2_dev.dev;
 
+	/* Temporary allow usage of bytesused = 0 */
+	src_vq->allow_zero_bytesused = 1;
+
 	ret = vb2_queue_init(src_vq);
 	if (ret)
 		return ret;
@@ -780,6 +783,13 @@ static int bdisp_try_fmt(struct file *file, void *fh, struct v4l2_format *f)
 			      BDISP_MIN_H, BDISP_MAX_H,
 			      ffs(format->h_align) - 1,
 			      0);
+
+	/* Always align to upper values */
+	if (pix->width < in_w)
+		pix->width += format->w_align;
+	if (pix->height < in_h)
+		pix->height += format->h_align;
+
 	if ((pix->width != in_w) || (pix->height != in_h))
 		dev_dbg(ctx->bdisp_dev->dev,
 			"%s size updated: %dx%d -> %dx%d\n", __func__,
-- 
2.7.4

