From 8a97e30d469dd342eff4787e6e3443d0c31a61a6 Mon Sep 17 00:00:00 2001
From: Christophe Priouzeau <christophe.priouzeau@st.com>
Date: Mon, 4 Mar 2019 16:59:30 +0100
Subject: [PATCH 3/3] correct-access_ok

Signed-off-by: Christophe Priouzeau <christophe.priouzeau@st.com>
---
 src/devicedrv/mali/linux/mali_ukk_mem.c | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/src/devicedrv/mali/linux/mali_ukk_mem.c b/src/devicedrv/mali/linux/mali_ukk_mem.c
index a700edf..a155373 100755
--- a/src/devicedrv/mali/linux/mali_ukk_mem.c
+++ b/src/devicedrv/mali/linux/mali_ukk_mem.c
@@ -202,10 +202,17 @@ int mem_write_safe_wrapper(struct mali_session_data *session_data, _mali_uk_mem_
 	kargs.ctx = (uintptr_t)session_data;
 
 	/* Check if we can access the buffers */
+#if LINUX_VERSION_CODE > KERNEL_VERSION(4, 20, 0)
+	if (!access_ok(kargs.dest, kargs.size)
+	    || !access_ok(kargs.src, kargs.size)) {
+		return -EINVAL;
+	}
+#else
 	if (!access_ok(VERIFY_WRITE, kargs.dest, kargs.size)
 	    || !access_ok(VERIFY_READ, kargs.src, kargs.size)) {
 		return -EINVAL;
 	}
+#endif
 
 	/* Check if size wraps */
 	if ((kargs.size + kargs.dest) <= kargs.dest
@@ -261,8 +268,13 @@ int mem_dump_mmu_page_table_wrapper(struct mali_session_data *session_data, _mal
 		goto err_exit;
 
 	user_buffer = (void __user *)(uintptr_t)kargs.buffer;
+#if LINUX_VERSION_CODE > KERNEL_VERSION(4, 20, 0)
+	if (!access_ok(user_buffer, kargs.size))
+		goto err_exit;
+#else
 	if (!access_ok(VERIFY_WRITE, user_buffer, kargs.size))
 		goto err_exit;
+#endif
 
 	/* allocate temporary buffer (kernel side) to store mmu page table info */
 	if (kargs.size <= 0)
-- 
2.7.4

